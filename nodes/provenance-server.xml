<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Your provenance roll description here
	</description>

	<copyright>
	Copyright (c) 2000 - 2012 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.5/v6.0 www.rocksclusters.org
	
	</copyright>

	<changelog>
	$Log$
	</changelog>

        <package>rabbitmq-server</package>
        <package>karma-service-core</package>

<post>

<!-- Setting mysql karma database -->
<file name="/etc/my.cnf" mode="append">

# globally configure default utf8 character set
[mysqld]
init_connect='SET collation_connection = utf8_general_ci'
init_connect='SET NAMES utf8'
default-character-set=utf8
character-set-server=utf8
character_set_client=utf8
collation-server=utf8_general_ci
skip-character-set-client-handshake
</file>

if [ ! -f /var/lock/subsys/mysqld ]; then
    /etc/init.d/mysqld start
    else
        /etc/init.d/mysqld restart
        fi

/sbin/chkconfig mysqld on
/usr/bin/mysqladmin create karmadb

<file name="/opt/provenance/karma/etc/db.pass" perms="0600">
<eval>
date +"%H:%M:%S"| md5sum | head -c10
</eval>
</file>

KARMA_DBPASS=`cat /opt/provenance/karma/etc/db.pass`
/bin/echo -en GRANT ALL PRIVILEGES ON karmadb.* TO 'karma'@'localhost' IDENTIFIED BY \'$KARMA_DBPASS\' \; | /usr/bin/mysql
/bin/echo -en GRANT SELECT ON mysql.proc TO 'karma'@'localhost' \; | /usr/bin/mysql

if [ -f /opt/provenance/karma/config/karma_db_schema.sql ]; then
    /usr/bin/mysql -u root karmadb &lt; /opt/provenance/karma/config/karma_db_schema.sql 
else
    echo "Karma database schema is not found"
fi

<!-- enable rabbitmq management plugins -->
if [ -x /opt/rabbitmq/sbin/rabbitmq-plugins ]; then
    /opt/rabbitmq/sbin/rabbitmq-plugins enable rabbitmq_management
fi

<!-- start rabbitMQ server -->
if [ ! -f /var/run/rabbitmq.pid ]; then
    /etc/init.d/karmaRMQserver start
else
    /etc/init.d/karmaRMQserver restart
fi

sleep 30
/sbin/chkconfig --add karmaRMQserver 

<!-- configure karma server password -->
<file name="/opt/provenance/karma/etc/server.pass" perms="0600">
<eval>
date +"%H:%M:%S"| md5sum | head -c10
</eval>
</file>
KARMA_SERVERPASS=`cat /opt/provenance/karma/etc/server.pass`
sed -i "s/KARMA_SERVERPASS/$KARMA_SERVERPASS/; s/KARMA_DBPASS/$KARMA_DBPASS/" /opt/provenance/karma/config/karma.properties

<!-- configure rabbitMQ  users  -->
/opt/rabbitmq/sbin/configKarmaUser.sh 

<!-- start karma server -->
if [ ! -f /var/run/karmaserver.pid ]; then
    /etc/init.d/karmaServer start
else
    /etc/init.d/karmaServer restart
fi

/sbin/chkconfig --add karmaServer 

</post>

</kickstart>
